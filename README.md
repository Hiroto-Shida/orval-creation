## (済) Next.js インストール

```
npx create-next-app@latest --yes --empty orval-creation
```

## テスト実行

```
npm run dev
```

- 画面(http://localhost:3000)に「Hello world!」がでてくれば OK

## (済) orval のインストール

```
npm i -D orval
```

## (済) その他必要なパッケージインストール

```
npm i hono zod @modelcontextprotocol/sdk @hono/zod-validator
```

## (済) orval の設定ファイル `orval.config.ts` と OpenAPI のスキーマ `schemas.yaml` を用意

```diff
/
  ├─ app/
  ├─ node_modules
+ ├─ orval.config.ts
  ├─ package-lock.json
  ├─ package.json
+ ├─ schemas.yaml
  └─ tsconfig.json
```

## orval の生成コマンド実行

### `package.json`

```diff
{
  "scripts": {
+    "generate": "orval --config ./orval.config.ts"
  },
```

### コマンド実行

```
npm run generate
```

生成されるファイルの確認

```diff
/
  ├─ app/
+ │  ├─ api/
+ │  │  └─ [[...route]]/
+ │  │     └─ route.ts
  │  └─ page.tsx
+ ├─ client/
+ │  └─ api.ts
+ ├─ endpoints/
+ │  ├─ colorful-moai/
+ │  │  └─ ...
+ │  └─ validator.ts
+ ├─ mcp
+  │  ├─ handlers.ts
+  │  ├─ http-client.ts
+  │  ├─ server.ts
+  │  └─ tool-schemas.zod.ts
  ├─ node_modules
+ ├─ schemas/
+ │  ├─ index.ts
+ │  └─ ...
  ├─ orval.config.ts
  ├─ package-lock.json
  ├─ package.json
  ├─ schemas.yaml
  └─ tsconfig.json
```

## API 周りの処理をちょっとだけ実装

自動生成の hono はあくまで雛形(エンドポイント)ができるだけなので実際の実装は必要

### Next.js の API Route の hono 実装にちょっと追加

#### `app/api/[[...route]]/route.ts`

```diff:ts
/**
 * Generated by orval v7.9.0 🍺
 * Do not edit manually.
 * カラフルモアイAPI
 * カラフルなモアイのリストを管理するAPI。
 * OpenAPI spec version: 1.0.0
 */
  import { Hono } from "hono";
  import {
    getColorfulMoaiHandlers,
    addColorfulMoaiHandlers,
  } from "../../../endpoints/colorful-moai/colorful-moai.handlers";
+ import { handle } from "hono/vercel";

- const app = new Hono();
+ const app = new Hono().basePath("/api");

  app.get("/colorful-moai", ...getColorfulMoaiHandlers);
  app.post("/colorful-moai", ...addColorfulMoaiHandlers);

- export default app;

+ export const GET = handle(app)
+ export const POST = handle(app)

```

### API に繋ぎ込み

`endpoints/colorful-moai/colorful-moai.handlers.ts`

```diff:ts
...
+ const COLORFUL_MOAI_LIST = ["赤モアイ", "緑モアイ", "青モアイ"];

  const factory = createFactory();
  export const getColorfulMoaiHandlers = factory.createHandlers(
    zValidator("response", getColorfulMoaiResponse),
    async (c: GetColorfulMoaiContext) => {
+     return c.json(COLORFUL_MOAI_LIST);
    }
  );
  export const addColorfulMoaiHandlers = factory.createHandlers(
    zValidator("json", addColorfulMoaiBody),
    zValidator("response", addColorfulMoaiResponse),
    async (c: AddColorfulMoaiContext) => {
+     const body = await c.req.json();

+     COLORFUL_MOAI_LIST.push(body["name"]);

+     return c.json(COLORFUL_MOAI_LIST);
    }
  );

```

## 画面から API 呼び出し (API クライアント)

### `app/page.tsx`に API 呼び出しを追加

```diff:tsx
+ import { getColorfulMoai } from "@/client/api";

- export default function Home() {
+ export default async function Home() {
+   const res = await getColorfulMoai({
+     cache: "no-cache",
+   });

    return (
      <main>
-       <div>Hello world!</div>
+       <div>{JSON.stringify(res.data)}</div>
      </main>
    );
  }
```

## Cursor と MCP を接続

### (済) mcp.json を作成

```diff
/
+ ├─ .cursor/
+ │  └─ mcp.json
  ├─ app/
  │  ├─ api/
...
```

### mcp.json を自身の環境に合わせて書き換え

```diff:json
{
  "mcpServers": {
    "colorsAPIServer": {
      "command": "npx",
      "args": [
        "tsx",
+       "~~~~~~~~/mcp/server.ts" // 絶対パスにする
      ]
    }
  }
}
```

### mcp.json の設定を cursor に実際に接続する

`.cursor/mcp.json` を設定すると、Cursor Settings > MCP > MCP Servers にカードが現れ、enable にして緑に点灯すれば接続完了

- うまくいかない時は server.ts が絶対パスになっているか確認
- cursor を再起動する等をする

## Next.js (API サーバ) を起動して MCP を通して 接続してみる

```
npm run dev
```
